a="""#################################################################################
#........h#..........t..#...#.#e........#.............#.....#....g..#...........#
#.#######.#.#####.#####.#.#.#.#.#.#####.#.###########.#.#.###.#####.#.#.#.#####.#
#.#.....#.#.#.#...#.#...#.#.#...#.#.#...#...#.....#...#.#.....#..l#...#.#.#...#.#
#.#.###.#.#.#.#.###.#.###.#.#####.#.#.###.#.#.###.###.#####.###.#.#####.###.#.#.#
#.#.#.#.#.....#.#.........#.......#...#.#.#.#.#.#...#.....#...#.#.....#.....#.#.#
#.#.#.#.#######.###################.###.#.#.#.#.###.#####.###.#.#####.#######.#.#
#.#.#.#...#...#.........#.....#...#.#...#.#.......#.#.....#...#.#...#...#.....#.#
###I#.###.#.#.#########.#.###.#.#.#.#.#.#########.#.#####.#.###.#.#.###.#.#####.#
#...#...#.#.#.........#.#.#.#...#...#.#.#.....#...#.....#.#.#...#.#...#...#...#.#
#.###.#.#.#.#########.#.#.#.#########.#.#Q###.#.#######.#.###.#######.#######.#.#
#...#.#.....#...#.......#.#...........#.#.#...#.....#...#.....#.....#.........#.#
###.#########.#.#########.#####.###.###.#.#.#########.#######.#.###.###.###.###.#
#...#...#...#.#.........#.....#.#...#...#.#.........#.#...#...#.#.#...#.#.#.#...#
#.###.#.#.#.#.#########.#####.#.#.#####.#.#########.#.#.#.#.###.#.###.#.#.#.#.###
#.....#...#.#...#.....#...#.#.#.#.#...#.#...#.....#...#.#.#.#...#.....#...#...#.#
#.#########.###.#.#######.#.#.#.#.#.#.#.#.#.#.#########.###.#.#.#####.###.#####.#
#.#.....#.#.#.....#.......#...#.#...#.#.#.#.#.........#.....#.#.#...#.#.......#.#
#Z#.#.#.#.#.#.#####.#######.###C#####.#.###.#.#######.#.#####.###.#.#.#######.#.#
#.#.#.#...#.....#.D.#.....#.#.......#.#.#...#.#...#.#...#...#...#.#.#.....#...#.#
#.###.###.#######.###S###.#.#########.###.###.#.#.#.#####.#####.#.#.#####.###.#.#
#.#..u#...#j#...#...#.#...#.........#...#.#.#...#...#.......#.#...#.....#...#.#.#
#.#.###.###.#.#.#.#.###.###########.###.#.#.#######.#######.#.#.#######.###.#.#.#
#...#.......#r#.#.#...#...#.......#.....#.#...#...#.........#.#.......#.#.#.#...#
#.#####.#####.#.#.#.#.###.#.###.#.#####.#.###.#.#.###.#######.#########.#.#.###.#
#.#...#.#...#.#.#.#.#...#.#...#.#.#.....#...#...#.....#.....#...........#...#...#
###.#.###.#.#.#.###.#####.###.#.###.#####.#.#####.#####.###.#############.#####.#
#...#.....#...#...W.#...#s..#.#.....#...#.#.....#.#.....#..y..#.....#.....#...#.#
#F#################.#.#.###.#.#######.#.#.#####.###.#####.###.#.###.#.#####.#.#.#
#.........#.........#.#.B...#...#...#.#.#.....#.....#.#...#...#.#.#.#.......#.#.#
#####.###.###########.#########.#.#.#.#.#####.#######.#.#######.#.#.#########.###
#...#..v#...#.........#.......#...#.#.#.#.....#a......#...........#.#.....#.#...#
#.#.#######.#.#########.#####.#####.#.#.#.###########.#############.#.#.#.#.###.#
#.#.........#.#...#...#.....#.#...#.#.#.#.......#.....#..m......#...#.#.#...#...#
#.###########.#.#.###.#####.#.#.#.#.#.#########.#.###.#.#######.#.#.#.#.#####.###
#p....#n......#.#.........#.#...#...#...#.....#...#...#.#.......#.#.#.#x#.....#.#
#.###.#.#######.#########.#.#########.#.#.#.#.#####.#####.#####.#.###.#.#.#####.#
#.#.#.#.#.....#.....O...#.#.#.......#.#.#.#.#...#...#...#...#.#.#.#...#...#.....#
#.#.#.#.#.#####.#######.###.#####.#.###.#.#.#####.###.#.###.#.#.#.#.#########.#.#
#...#...#.............#...........#.......#..o........#.....#...#.............#.#
#######################################.@.#######################################
#q......M.............#.....#.....#.#.........#...#..w..........#.#.....#.......#
#######.#####.#######.#.#.#.#.###.#.#.#.#.###.###.#.###########.#.#.#.#.#####.#.#
#.....#...#...#.....#.#.#.#.#.#.#.#...#.#...#.....#...#...#...#.#...#.#...J...#.#
#.###.#####.###.#####.#.#.#.#.#.#.#####.###.#####.###.#.#.#.#.#.#####.#########.#
#.#.#.#.....#.......#.#.#.#...#.#.......#...#.#...#.#...#...#.#.......#.....#.#.#
#.#.#.#.###########.#.###.#####.#######.#.###.#.###.#########.#######.#.###V#.#.#
#.#...#.#...........#.....#.......#.....#.#...#.#.....#.#.R...#...#.#.#.#...#.#.#
#.#.###.#.###.#####.#######.###.#.#.#####.#.###.#.###.#.#.###.#.#.#.#.#.#.###U#.#
#.#.....#...#...#.#.#.......#.#.#.#.#...#.#...#...#.#.#.#...#.#.#.#..d#.#...#...#
#.#########.###.#.#.#.#######.#.#.#.###.#.#.#.#####.#.#.###.###.#.#####.###.#.###
#.#...#.......#.#...#...#.....#.#.#.#...#.#.#.#...........#....f#.......#.P.#...#
#.#.#.#########.#.#####.#.#####.#.#.#.###.#.#.#.#######.###########.#####.#####.#
#.Y.#.......#...#.....#.#...#...#.#.#...#.#.#...#.#...#.#.....#...#...#...#...#.#
#.#########.#.#####.###.###.#.###.#.###.#.#.#####.#.#.###.###.#.#.#####.###.###.#
#.#...#.....#.#.....#...#...#...#.#...#.#.#.#.....#.#.....#...#.#.......#...#...#
#.#.#.#.#####.#.#####.###.#.###.#####.#.#.#.#.###.#.#######.###N#########.###.###
#...#.#.#...#.#.....#...#.#...#.....#.#.#.#...#...#...#.....#...#.#.........#...#
#####.#.#.#.#.#########.#.###.#####.#.#.#.#####.#####.#.###.#.###.#.#######.###.#
#...#.#...#.#.............#.....#...#...#.#...#...#...#...#.#.#...#...#...#..z#.#
#K###.#####.#.###################.#####.#.#.#.###.#.#####.#.#.#.#.###.#.#.#.#.#.#
#.....#...#.#.#.....#.....#.....#.....#.#.#.#...#.#...#...#.#b#.#...#...#.#.#.#.#
#####.#.###.#.#####.#####.#.###.#####.#.#.#.###.###.###.###.#######.#####.#.###.#
#...#.#.#...#...#.......#...#.#.....#.#.#...#.#.#...#...#.........#...#...#.....#
#.#.#.#.#.#####.#.#####.#####.#####.#.#.#.###.#.#.###.###########.#.#.#.#########
#.#.#...#.#...#...#...#...#.#...#...#...#.#.A.#.....#.....#..k..#.#.#.#.#.......#
#.#.#####.###.#####.#####.#.#.#.#.###.###.###.#######.###.#####.#.#.###.#.#######
#.#.......#.......#.....#.#...#.#...#...#.......#...#.#.#.....#...#.#...#.......#
#X#########.#####.#.###.#.#####.###.#####.#######.#.#.#.#####.#.###.#.###.#####.#
#.....#.......#...#.#.#.#...#.....#.....#.#.......#.#...#.....#...#.#...#.....#.#
#####.#.#####.#.###.#.#.###.#.#########.###.#######.###.#.#######.#.###.#.#####.#
#.....#...#...#...#.#.#.....#.#...#.....#...#.....#.#...#.#.#.....#...#.#.#...#.#
#.#######.#.#######.#.#######.#.#.#.#####.#####.###.#####.#.#.#####.#.#.###.#.#.#
#.......#.#.............#.....#.#...#...#.....#.......#...#...#.....#.#.....#.#.#
#.#####.###############.#.###.#.#####.#.#.###.#######.#.###.#######.#.#######.#.#
#.#.....#...T.....#...#.#.#...#.....#.#.#...#.......#...#......c....#.......#...#
###.###.#.#######.#H#.#.#.#.#######.#.#####.#######.#####.#####.###############.#
#...#...#.#.#.....#.#.#...#...#.....#...#...#.E...#...#...#...#.#.......#.......#
#.#######.#.#.#####.#.#########.#######.#.###.###.###.#####.#.###.#####.#.#######
#.....L.....#.......#.............G..i..#.....#.....#.......#.........#.........#
#################################################################################"""
test="""#########
#b.A.@.a#
#########"""
test="""#################
#i.G..c...e..H.p#
########.########
#j.A..b...f..D.o#
########@########
#k.E..a...g..B.n#
########.########
#l.F..d...h..C.m#
#################"""
test="""########################
#@..............ac.GI.b#
###d#e#f################
###A#B#C################
###g#h#i################
########################"""
a=test
b=a.replace("#","▒").replace("."," ")
grid=[[x for x in y] for y in b.splitlines()]


w,h = len(grid[0]),len(grid)

dirs = [[1,0],[0,1],[-1,0],[0,-1]]

def getNeighs(x,y): return [(x+dx, y+dy) for dx,dy in dirs]

def readNeigh(neigh):
    xx,yy = neigh
    #if -1<xx<w and -1<yy<h:
    return grid[yy][xx]
    #else: return "█"

def getConnectionCount(x,y): return 4-[readNeigh(neigh) for neigh in getNeighs(x,y)].count("▒")

def isJunction(x,y): return getConnectionCount(x,y) > 2 and readNeigh((x,y)) not in "▒"

def isDeadEnd(x,y): return getConnectionCount(x,y) == 1 and readNeigh((x,y)) not in "█▒"

def isHall(x,y): return getConnectionCount(x,y) == 2 and readNeigh((x,y)) not in "█▒"


def trim(x,y):
    #  grid[y][x] = "█"
    trimList=[(x,y)]
    breakFlag=False
    while not breakFlag:
        neighs = getNeighs(x,y)
        for neigh in neighs:
            if neigh in trimList or readNeigh(neigh)=="▒": continue
            xx,yy=neigh
            if isJunction(xx,yy) or readNeigh(neigh).isalpha(): 
                for xxx,yyy in trimList:
                    grid[yyy][xxx] = "▒"
                breakFlag=True
                break
            if  isHall(xx,yy): 
                trimList.append(neigh)
                x,y=neigh

def countAlphs():
    counter=0
    for j,y in enumerate(grid):
        for i,x in enumerate(y):
            if x.isalpha():counter+=1
    return counter


#delete dead ends
for j,y in enumerate(grid):
    for i,x in enumerate(y):
        if x not in "█▒@":
            if isDeadEnd(i,j) and not readNeigh((i,j)).isalpha(): trim(i,j)

#delete dead ends
for j,y in enumerate(grid):
    for i,x in enumerate(y):
        if x not in "█▒@":
            if isDeadEnd(i,j) and readNeigh((i,j)).upper() == readNeigh((i,j)): trim(i,j)

#find start
for j,line in enumerate(grid):
    if "@" in line:
        globalStart = (line.index("@"),j)
k,l=globalStart

#remove start tile
# if test!=a:
#     grid[l][k] = "▒"

#add back start tile
#grid[l][k]="@"

#light up junctions
for j,y in enumerate(grid):
    for i,x in enumerate(y):
        if x not in "█▒":
            if isJunction(i,j) and not (i,j)==globalStart: grid[j][i]="█"

for line in grid:
    print("".join([x*2 for x in line]))

def walk(x,y):
    original = (x,y)
    paths={}
    neighs = getNeighs(x,y)
    for neigh in neighs:
        if readNeigh(neigh)=="▒": continue
        xx,yy = neigh
        path=[neigh]
        breakFlag = False
        while True:
            for neigh in getNeighs(xx,yy):
                xx,yy = neigh
                if any([ neigh in path, neigh == original, readNeigh(neigh)=="▒" ]): continue
                if isJunction(xx,yy) or readNeigh(neigh).isalpha():
                    path.append(neigh)
                    breakFlag=True
                    break
                if  isHall(xx,yy): 
                    path.append(neigh)
                    xx,yy=neigh
                    break
            if breakFlag: break
        paths[neigh] = len(path)
    return paths

def bfs():
    k,l=globalStart
    tree={}
    if test!=a:queue=[(k-1,l-1)]
    else: queue=[globalStart]
    while queue:
        node = queue.pop(0)
        x,y=node
        if readNeigh(node).isalpha(): node=readNeigh(node)
        if node not in tree: tree[node] = {}
        dic=walk(x,y)
        for dest,dist in dic.items():
            char = readNeigh(dest)
            if not char.isalpha():char=dest
            if char not in tree:
                tree[char] = {}
                queue.append(dest)
            tree[char][node] = dist
            tree[node][char] = dist
    return tree


tree = bfs()
#for x in sorted(list([x for x in tree.keys() if type(x)==tuple])): print(x,tree[x])
#for x in sorted(list([x for x in tree.keys() if type(x)==str])): print(x,tree[x])

def bfs2(start):
    seen={}
    queue=[(start,0,[])]
    while queue:
        node,dist,doors = queue.pop()
        if node not in seen: seen[node] = [dist,doors[::]]
        elif seen[node][0] <= dist: continue
        for dest,dist2 in tree[node].items():
            newDoors=doors[::]
            if type(dest)==str:
                if dest.upper()==dest: newDoors=doors[::]+[dest]
            queue.append((dest,dist+dist2,newDoors))
    return seen

allDoors=sorted([y for y in [x for x in tree if type(x)==str] if y.upper()==y])
allKeys=sorted([y.lower() for y in [x for x in tree if type(x)==str] if y.lower()==y and y.upper() not in allDoors]) + [x.lower() for x in allDoors]
allKeys2 = allKeys[::-1]
po2Dict={x:2**allKeys2.index(x) for x in allKeys2}

def doorsToBitwise(doors): return int("0b"+"".join(["1" if x in [y.lower() for y in doors] else "0" for x in allKeys]),2)
allBits=doorsToBitwise(allDoors)

alphs=[y for y in [x for x in tree if type(x)==str] if y.lower()==y]
keys={}
sx,sy=globalStart
startTiles = [(sx,sy)]
# startTiles = [(sx+1,sy+1),(sx-1,sy+1),(sx+1,sy-1),(sx-1,sy-1)]
for start in alphs+startTiles:
    keys[start]={}
    dic = bfs2(start)
    for key in dic:
        if type(key) != str: continue
        if key==start or key not in alphs:continue
        keys[start][key]={}
        dist,doors = dic[key]
        keys[start][key]["dist"] = dist
        keys[start][key]["doors"] = doorsToBitwise(doors)
for x in keys: print(x,keys[x])


def bfs3():
    iterations=0
    seen={}
    queue=[(node,2,0) for node in startTiles]
    while queue:
        node,dist,keysBits=queue.pop()
        iterations+=1
        if iterations%10_000==0:print(iterations)
        if keysBits in seen:
            if dist > seen[keysBits]: continue
        else:
            seen[keysBits] = dist
        if dist < seen[keysBits]: seen[keysBits] = dist
        for neigh in keys[node]:
            neighObj = keys[node][neigh]
            if (doors:=neighObj['doors']) & keysBits == doors:
                if not ( po2:=po2Dict[neigh] ) & keysBits:
                    newKeysBits = po2 + keysBits
                    queue.append((neigh,dist+neighObj["dist"],newKeysBits))
    print(seen[doorsToBitwise(allKeys)]) #part1

bfs3()
#6430 too low
#7448 too high
#7444 too high #-70
#7438 too high #-150
